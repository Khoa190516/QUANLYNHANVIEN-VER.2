<!DOCTYPE html>
<html lang="en">

<head>
    <title>Danh sách đơn hàng | Quản trị Admin</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Main CSS-->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous"> -->
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css">
    <!-- or -->
    <link rel="stylesheet" href="https://unpkg.com/boxicons@latest/css/boxicons.min.css">

    <!-- Font-icon css-->
    <link rel="stylesheet" type="text/css"
        href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css">

</head>
<style>
    .find-trip-txt {
        margin-left: 10px;
    }

    #loading {
        position: fixed;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        opacity: 0.7;
        background-color: #fff;
        z-index: 99;
    }

    #loading-image {
        z-index: 100;
    }
</style>

<body class="app sidebar-mini rtl">
    <!-- Navbar-->
    <header class="app-header">
        <!-- Sidebar toggle button--><a class="app-sidebar__toggle" href="#" data-toggle="sidebar"
            aria-label="Hide Sidebar"></a>
        <!-- Navbar Right Menu-->
        <ul class="app-nav">


            <!-- User Menu-->
            <li><a class="app-nav__item" href="/index.html"><i class='bx bx-log-out bx-rotate-180'></i> </a>

            </li>
        </ul>
    </header>
    <!-- Sidebar menu-->
    <div class="app-sidebar__overlay" data-toggle="sidebar"></div>
    <aside class="app-sidebar">
        <div class="app-sidebar__user">
            <div>
                <p class="app-sidebar__user-name"><b>VEXETIENLOI</b></p>
                <p class="app-sidebar__user-designation">Chào mừng bạn trở lại</p>
            </div>
        </div>
        <hr>
        <ul class="app-menu">

            <!-- <li class="link-staff"><a class="app-menu__item " href="index.html"><i class='app-menu__icon bx bx-tachometer'></i><span
                        class="app-menu__label">Bảng điều khiển</span></a></li>
            <li class="link-staff"><a class="app-menu__item " href="table-data-table.html"><i class='app-menu__icon bx bx-id-card '></i>
                    <span class="app-menu__label">Quản lý nhân viên</span></a></li> -->

            <li><a class="app-menu__item" href="table-data-product.html"><i
                        class='app-menu__icon bx bx-purchase-tag-alt'></i><span class="app-menu__label">Quản lý
                        xe</span></a>
            </li>
            <!-- <li class="link-staff"><a class="app-menu__item" href="table-data-oder.html"><i class='app-menu__icon bx bx-task'></i><span
                        class="app-menu__label">Quản lý nhà xe</span></a></li> -->
            <li><a class="app-menu__item" href="table-data-banned.html"><i class='app-menu__icon bx bx-run'></i><span
                        class="app-menu__label">Quản lý tuyến đuòng
                    </span></a></li>
            <li><a class="app-menu__item" href="table-data-money.html"><i class='app-menu__icon bx bx-dollar'></i><span
                        class="app-menu__label">Quản lý chuyến đi</span></a></li>
            <li><a class="app-menu__item active" href="quan-ly-bao-cao.html"><i
                        class='app-menu__icon bx bx-pie-chart-alt-2'></i><span class="app-menu__label">Báo cáo doanh
                        thu</span></a>
            </li>

        </ul>
    </aside>
    <main class="app-content">
        <div class="row">
            <div class="col-md-12">
                <div class="app-title">
                    <ul class="app-breadcrumb breadcrumb">
                        <li class="breadcrumb-item"><a href="#"><b>Báo cáo doanh thu </b></a></li>
                    </ul>
                    <div id="clock"></div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 col-lg-3">
                <div class="widget-small primary coloured-icon"><i class='icon  bx bxs-user fa-3x'></i>
                    <div class="info">
                        <h4>Tổng đơn hàng</h4>
                        <p class="total-orders"><b>26 đơn hàng</b></p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="widget-small info coloured-icon"><i class='icon bx bxs-purchase-tag-alt fa-3x'></i>
                    <div class="info">
                        <h4>Tổng chuyến đi</h4>
                        <p class="total-trips"><b>8580 sản phẩm</b></p>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 col-lg-3">
                <div class="widget-small primary coloured-icon"><i class='icon fa-3x bx bxs-chart'></i>
                    <div class="info">
                        <h4>Tổng thu nhập</h4>
                        <p class="revenue"><b>104.890.000 đ</b></p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="widget-small info coloured-icon"><i class='icon fa-3x bx bxs-user-badge'></i>
                    <div class="info">
                        <h4>Tổng xe</h4>
                        <p class="bus-count"><b>3 nhân viên</b></p>
                    </div>
                </div>
            </div>
            <!-- <div class="col-md-6 col-lg-3">
                <div class="widget-small warning coloured-icon"><i class='icon fa-3x bx bxs-tag-x'></i>
                    <div class="info">
                        <h4>Hết hàng</h4>
                        <p><b>1 sản phẩm</b></p>
                    </div>
                </div>
            </div> -->
            <div class="col-md-6 col-lg-3">
                <div class="widget-small danger coloured-icon"><i class='icon fa-3x bx bxs-receipt'></i>
                    <div class="info">
                        <h4>Đơn hàng hủy</h4>
                        <p class="cancel-order"><b>2 đơn hàng</b></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="tile">
                    <div>
                        <h3 class="tile-title">TỔNG ĐƠN HÀNG</h3>
                    </div>
                    <div id="loading">
                        <span id="loading-image" class="spinner-border spinner-border-sm"></span>
                        <span class="find-trip-txt">Đang xử lý...</span>
                    </div>
                    <div class="tile-body">
                        <table class="table table-hover table-bordered" id="myTable">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Ngày mua</th>
                                    <th>Số lần bỏ vé</th>
                                    <th>Điểm đón</th>
                                    <th>Thời gian đón</th>
                                    <th>Mã chuyển tiền</th>
                                    <th>Các ghế đặt</th>
                                    <th>Tổng tiền</th>
                                    <th>Trạng thái</th>
                                    <th>Tính năng</th>
                                </tr>
                            </thead>
                            <tbody id="table-bus">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal order-detail-modal" id="exampleModal" tabindex="-1" role="dialog"
            aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header text-body">
                        <h5 class="modal-title" id="exampleModalLabel">Thông tin đơn hàng</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div id="detail-content" class="card card-stepper" style="border-radius: 5px;">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-detail-close">Đóng</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="text-right" style="font-size: 12px">
            <p><b>Hệ thống quản lý chuyến đi</b></p>
        </div>
    </main>
    <!-- Essential javascripts for application to work-->
    <script src="js/jquery-3.2.1.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <!-- <script src="src/jquery.table2excel.js"></script> -->
    <script src="js/main.js"></script>
    <!-- The javascript plugin to display page loading on top-->
    <script src="js/plugins/pace.min.js"></script>
    <!-- Page specific javascripts-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.js"></script>
    <!-- Data table plugin-->
    <script type="text/javascript" src="js/plugins/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="js/plugins/dataTables.bootstrap.min.js"></script>
    <!-- <script type="text/javascript">$('#sampleTable').DataTable();</script> -->
    <script type="text/javascript">
        // Admin functions
        function reload() {
            window.location.reload();
        }
        //Confirm chuyen tien
        function confirmTransferred(orderId) {
            var isCanConfirm = true;
            orders.forEach(element => {
                if (element.id == orderId) {
                    if (element.status != "Chờ xác nhận" && element.status != "Thanh toán tại quầy") {
                        isCanConfirm = false;
                    }
                }
            });

            if (isCanConfirm == true) {
                $("#loading").show();
                const token = localStorage.getItem('token');
                console.log(token);

                var busUrl = "https://localhost:44305/api/v1/payment/confirm-transferred";
                fetch(busUrl, {
                    method: 'PUT',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': "Bearer " + token
                    },
                    body: JSON.stringify({ orderId: orderId })
                }).then(response => {
                    return response.json();
                }).then(data => {
                    swal("Thành Công!", "Đã xác nhận chuyển khoản", "success");
                    $("#loading").hide();
                    setTimeout(function () { window.location.reload() }, 2000);
                })
            } else {
                $("#loading").hide();
                swal("Lỗi", "Đơn hàng đã thanh toán hoặc hết hiệu lực", "error");

            }

        }
        // Huy don hang
        function cancelOrder(orderId) {
            var isCanCancel = true;
            orders.forEach(element => {
                if (element.id == orderId) {
                    if (element.status == "Đã hủy" || element.status == "Đã hết hạn" || element.status == "Không thanh toán") {
                        isCanCancel = false;
                    }
                }
            });

            if (isCanCancel == true) {
                $("#loading").show();
                const token = localStorage.getItem('token');
                console.log(token);

                var busUrl = "https://localhost:44305/api/v1/payment/cancel-order";
                fetch(busUrl, {
                    method: 'PUT',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': "Bearer " + token
                    },
                    body: JSON.stringify({ orderId: orderId })
                }).then(response => {
                    return response.json();
                }).then(data => {
                    swal("Thành công", "Hủy vé thành công", "success");
                    $("#loading").hide();
                    setTimeout(function () { window.location.reload() }, 2000);
                })
            } else {
                $("#loading").hide();
                swal("Lỗi", "Đơn hàng đã hết hiệu lực", "error");

            }
        }

        function viewDetail(id) {
            $(".order-detail-modal").show()
            var token = localStorage.getItem('token')
            var detail = "";
            var url = "https://localhost:44305/api/v1/payment/get-by-id?orderId=" + id;

            console.log(id)

            $("#detail-content").empty()

            fetch(url, {
                headers: {
                    'Authorization': "Bearer " + token
                }
            }).then(res => res.json()).then(res => {
                detail = res;
                console.log(res);
                //alert("details")
                console.log(detail[0])
                var order = detail[0]
                var statusClass = "text-info";
                if (order.status == "Đã hủy" || order.status == "Đã hết hạn" || order.status == "Không thanh toán") {
                    statusClass = "text-danger";
                } else if (order.status == "Đã thanh toán") {
                    statusClass = "text-success"
                } else {
                    statusClass = "text-info"
                }

                $("#detail-content").append(
                    '<div class="card-header p-4">' +
                    '<div>ID: ' + order.id + '</div>' +
                    '<div><b>Số lần bỏ vé: </b><b class="text-danger">' + order.boomCounter + '</b></div>' +
                    '</div>' +
                    '<div class="card-body p-4">' +
                    '<div>Email: <b>' + order.email + '</b></div>' +
                    '<div>Số điện thoại<b>: ' + order.phone + '</b></div>' +
                    '<div>Địa chỉ: <b>' + order.address + '</b></div><br/>' +
                    '<div>Chuyến: <b>' + order.tripName + '</b></div>' +
                    '<div>Ngày mua: <b>' + order.orderDate + '</b></div>' +
                    '<div>Điểm đón: <b>' + order.pickUp + " - " + order.departureDate + '</b></div>' +
                    '<div>Điểm trả: <b>' + order.dropOff + '</b></div><br/>' +
                    '<div>Xe: <b>' + order.busNumber + '</b></div>' +
                    '<div>Ghế: <b class="text-info">' + order.seatsName + '</b></div>' +
                    '<div class="cart-footer p-4">' +
                    '<div>Trạng thái: <span class="' + statusClass + '">' + order.status + '</span></div>' +
                    '<div>Mã đơn hàng: <span class="text-info">' + order.code + '</span></div>' +
                    '<div>Tổng tiền: <span class="text-info">' + order.amount.toLocaleString() + ' VND</span></div>' +
                    '</div>'
                )
            });
        }

        var orders = [];
        $(document).ready(function () {

            $(".order-detail-modal").hide();
            $("#loading").hide();
            $(".btn-detail-close").on('click', function () {
                $(".order-detail-modal").hide();
            })

            //Fetch Orders
            const token = localStorage.getItem('token');
            console.log(token);

            var reportUrl = "https://localhost:44305/api/v1/payment/orders-report";
            fetch(reportUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Authorization': "Bearer " + token
                },
            }).then(response => {
                return response.json();
            }).then(response => {
                $(".total-orders b").text(response.totalOrders + " đơn hàng");
                $(".cancel-order b").text(response.cancelOrders + " đơn hàng");
                $(".total-trips b").text(response.totalTrips + " chuyến");
                $(".revenue b").text(response.totalRevenue.toLocaleString() + " VND");
                $(".bus-count b").text(response.totalBus + " xe");
            })

            var ordersUrl = "https://localhost:44305/api/v1/payment/orders-by-company";
            fetch(ordersUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Authorization': "Bearer " + token
                },
            }).then(response => {
                return response.json();
            }).then(data => {
                orders = data;
                console.log(orders);
                console.log(orders.length);
                $("#table-bus").empty();
                orders.forEach(element => {
                    var statusTxt = "text-info";
                    if (element.status == "Đã thanh toán") {
                        statusTxt = "text-success";
                    } else if (element.status == "Đã hủy" || element.status == "Đã hết hạn" || element.status == "Không thanh toán") {
                        statusTxt = "text-danger";
                    } else {
                        statusTxt = "text-primary"
                    }
                    var row = $('<tr>' +
                        '<td id="name' + element.id + '">' + element.email + '</td>' +
                        '<td id="name' + element.id + '">' + element.orderDate + '</td>' +
                        '<td id="email' + element.id + '">' + element.boomCounter + '</td> ' +
                        '<td id="name' + element.id + '">' + element.pickUp + '</td>' +
                        '<td id="name' + element.id + '">' + element.departureDate + '</td>' +
                        '<td id="phone' + element.id + '">' + element.code + '</td> ' +
                        '<td id="role' + element.id + '">' + element.seatsName + '</td> ' +
                        '<td id="email' + element.id + '">' + element.amount.toLocaleString() + ' VND</td> ' +
                        '<td class="' + statusTxt + '" id="email' + element.id + '">' + element.status.toUpperCase() + ' </td> ' +
                        '<td> ' +
                        '<button class="confirm-btn btn btn-success" onclick=confirmTransferred("' + element.id + '")>Xác nhận chuyển khoản</button>' +
                        '<button  class="cancel-btn btn btn-danger" onclick=cancelOrder("' + element.id + '")>Hủy vé</button>' +
                        '<br/><button class="view-btn btn btn-info" onclick=viewDetail("' + element.id + '") >Xem chi tiết</button>' +
                        '</td> ' +
                        '</tr>'
                    );
                    $("#table-bus").append(row)
                });
                $("#myTable").DataTable()
            }).catch(err => {
                console.log(err);
            })
        })
    </script>
    <!-- <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script> -->
</body>

</html>